<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-4e32f602-f702-4156-8dc9-2926aaca736a"></attachment><p><br></p><h1><strong>告警系统概要设计 方案二</strong></h1><p><br></p><p><br></p><h1><strong>Grafana+Prometheus&nbsp;实现服务器监控告警</strong></h1><p>&nbsp;</p><p>&nbsp;目录：</p><p>·&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>Grafana+Prometheus 实现服务器监控告警</u></a>&nbsp;</p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>一：介绍</u></a>&nbsp;</p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>node_exporter – 用于机器系统数据收集</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>mysqld_exporter – 用于MySQL服务器数据收集</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>zookeeper_exporter – 用于Zookeeper服务器数据收集</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>redis_exporter – 用于Redis服务器数据收集</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>SpringBoot_exporter - 用于JVM服务数据收集 micrometer-registry-prometheus</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>二： node_exporter</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>三： Prometheus</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>四：系统运行情况 告警</u></a>&nbsp;</p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u> 1.配置告警： 系统负载告警版面</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>2.配置告警： CPU、IO、内存告警</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>3.配置告警： 服务器异常退出告警</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>五： 告警邮件配置</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>六： 后续接入 dubbo 微服务监控</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>七： 自定义接入监控系统 Prometheus</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>八：告警其他方式扩展</u></a>&nbsp;</p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>8.1邮件： 已经配置实现</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>8.2短信：</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>8.3微信：</u></a></p><p>§&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>8.4钉钉：已经实现</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u> 九：mysqld_exporter B2C监控-开发测试环境数据库监控</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>十：zookeeper_exporter B2C监控-开发测试环境服务注册中心监控</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>十一：redis_exporter B2C监控-开发测试环境服务Redis监控</u></a></p><p>o&nbsp;<a href="about:blank" target="_blank" style="color: rgb(0, 0, 255);"><u>十二：spring boot B2C监控-节点服务JVM信息监控</u></a></p><h3><strong>一：介绍</strong></h3><p>Prometheus官网是这么介绍，一个最初在SoundCloud上构建的开源系统监视和警报工具包。</p><p>Prometheus是一个完整的监控和趋势系统，包括基于时间序列数据的内置和主动抓取，存储，查询，绘图和警报。</p><p>简单来说，我们可以用Prometheus来监控包括linux，window系统，nginx以及mysql的性能指标。</p><p>&nbsp;</p><p>Grafana，一个将数据可视化的软件，具有非常高大上的ui设计。所以采用Grafana作为Prometheus的可视化工具</p><p>&nbsp;</p><p>Prometheus生态系统由多个组件组成，它们中的一些是可选的。多数Prometheus组件是Go语言写的，这使得这些组件很容易编译和部署。Prometheus提供多种类型的Exporter用于采集各种不同服务的运行状态。目前支持的有数据库、硬件、消息中间件、存储系统、HTTP服务器、JMX等。</p><p>&nbsp;</p><p><br></p><p>Prometheus Server：主要负责数据采集和存储，提供PromQL查询语言的支持。另外还提供查询和&nbsp;Alert&nbsp;Rule&nbsp;配置管理。</p><p>&nbsp;&nbsp;&nbsp;客户端SDK：官方提供的客户端类库有go、java、scala、python、ruby，其他还有很多第三方开发的类库，支持nodejs、php、erlang等。如client libraries,用于对接&nbsp;Prometheus&nbsp;Server,可以查询和上报数据.</p><p>&nbsp;&nbsp;&nbsp;Push Gateway：支持临时性Job主动推送指标的中间网关。用于批量，短期的监控数据的汇总节点，主要用于业务数据汇报等。</p><p>&nbsp;&nbsp;&nbsp;PromDash：使用Rails开发可视化的Dashboard，用于可视化指标数据。</p><p>&nbsp;&nbsp;&nbsp;Explorer：它是Prometheus的一类数据采集组件的总称。它负责从目标处搜集数据，并将其转化为Prometheus支持的格式。与传统的数据采集组件不同的是，它并不向中央服务器发送数据，而是等待中央服务器主动前来抓取。如</p><p>&nbsp;&nbsp;&nbsp;&nbsp;node_exporter：会持续不断采集Linux系统中各种操作系统本身相关的监控参数的程序，采集量很大很全，往往默认的采集项就远超过你的实际需求。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;Alertmanager：警告管理器，用于告警通知管理，用来进行报警。</p><p>&nbsp;&nbsp;&nbsp;&nbsp;Prometheus_cli：命令行工具</p><p>其他辅助性工具：多种导出工具，可以支持Prometheus存储数据转化为HAProxy、StatsD、Graphite等工具所需要的数据存储格式</p><p>&nbsp;<img src="//:0" height="181" width="468"></p><p><br></p><p><br></p><h4><strong>node_exporter – 用于机器系统数据收集 </strong></h4><h4><strong>mysqld_exporter – 用于MySQL服务器数据收集</strong></h4><h4><strong>zookeeper_exporter – 用于Zookeeper服务器数据收集</strong></h4><h4><strong>redis_exporter – 用于Redis服务器数据收集</strong></h4><h4><strong>SpringBoot_exporter - 用于JVM服务数据收集&nbsp;micrometer-registry-prometheus</strong></h4><p><br></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>二：&nbsp;node_exporter</strong></h3><p>&nbsp;</p><p>节点信息收集：&nbsp;&nbsp;CPU、IO、内存、磁盘、流量、系统负载</p><p>&nbsp;<img src="//:0" height="235" width="468"></p><p><a href="http://192.168.9.132:3000/d/9CWBz0bik/1-node-exporter-0-16-0-17-for-prometheus-jian-kong-zhan-shi-kan-ban?orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/9CWBz0bik/1-node-exporter-0-16-0-17-for-prometheus-jian-kong-zhan-shi-kan-ban?orgId=1</u></a></p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>三： Prometheus</strong></h3><p>配置文件 prometheus.yml</p><p># my global config</p><p>global:</p><p>&nbsp;&nbsp;scrape_interval:&nbsp;&nbsp;&nbsp;&nbsp;15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</p><p>&nbsp;&nbsp;evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</p><p>&nbsp;&nbsp;# scrape_timeout is set to the global default (10s).</p><p>&nbsp;</p><p># Alertmanager configuration</p><p>alerting:</p><p>&nbsp;&nbsp;alertmanagers:</p><p>&nbsp;&nbsp;- static_configs:</p><p>&nbsp;&nbsp;&nbsp;&nbsp;- targets:</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- 192.168.9.142:9093</p><p>&nbsp;</p><p># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</p><p>rule_files:</p><p>&nbsp;&nbsp;# - "first_rules.yml"</p><p>&nbsp;&nbsp;# - "second_rules.yml"</p><p>&nbsp;</p><p># A scrape configuration containing exactly one endpoint to scrape:</p><p># Here it's Prometheus itself.</p><p>scrape_configs:</p><p>&nbsp;&nbsp;# The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</p><p>&nbsp;&nbsp;- job_name: 'prometheus'</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;# metrics_path defaults to '/metrics'</p><p>&nbsp;&nbsp;&nbsp;&nbsp;# scheme defaults to 'http'.</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;static_configs:</p><p>&nbsp;&nbsp;&nbsp;&nbsp;- targets: ['192.168.9.142:9090','192.168.9.142:9100','192.168.9.132:9100','192.168.9.133:9100','192.168.9.134:9100','192.168.9.135:9100','192.168.9.136:9100','192.168.9.137:9100']</p><p><br></p><p>配置文件 prometheus.ym</p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>四：系统运行情况&nbsp;告警</strong></h3><p>&nbsp;</p><p><br></p><h4><strong>&nbsp;&nbsp;1.配置告警： 系统负载告警版面</strong></h4><p>收集简单&nbsp;机器直接执行node_exporter</p><p>优点： 无需配置，即可收集负载信息</p><p>配置告警阈值： 系统负载为：1&nbsp;&nbsp;</p><p>&nbsp;<img src="//:0" height="235" width="468"></p><p><a href="http://192.168.9.132:3000/d/pxLvLSrmz/b2cjian-kong-xi-tong-fu-zai-gao-jing-mian-ban?orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/pxLvLSrmz/b2cjian-kong-xi-tong-fu-zai-gao-jing-mian-ban?orgId=1</u></a></p><p>&nbsp;</p><p><br></p><h4><strong>2.配置告警： CPU、IO、内存告警</strong></h4><p>收集简单&nbsp;机器直接执行node_exporter</p><p>优点： 无需配置，即可收集负载信息</p><p>配置告警阈值： CPU：90%</p><p><img src="//:0" height="236" width="468"><a href="http://192.168.9.132:3000/d/bt2CYS9iz/b2cjian-kong-cpu-iogao-jing-mian-ban?orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/bt2CYS9iz/b2cjian-kong-cpu-iogao-jing-mian-ban?orgId=1</u></a></p><p><br></p><p><br></p><h4><strong>3.配置告警： 服务器异常退出告警</strong></h4><p>收集简单&nbsp;引入 maven</p><p>优点： 无需配置，即可收集负载信息</p><p>配置告警阈值：机器运行时间丢失</p><p><img src="//:0" height="208" width="468"></p><p><a href="http://192.168.9.132:3000/d/kcxkHBrmz/b2cjian-kong-fu-wu-qi-guan-bi-gao-jing?orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/kcxkHBrmz/b2cjian-kong-fu-wu-qi-guan-bi-gao-jing?orgId=1</u></a></p><p><br></p><p><br></p><h3><strong>五： 告警邮件配置</strong></h3><p>结合grafana 配置告警邮件</p><p>&nbsp;<img src="//:0" height="376" width="412"></p><p>&nbsp;<img src="//:0" height="341" width="468"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>六： 后续接入 dubbo 微服务监控</strong></h3><p>初步方案：&nbsp;spring boot 监控接入到 Prometheus</p><p>&nbsp;<img src="//:0" height="241" width="468"></p><p><br></p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>七： 自定义接入监控系统 Prometheus</strong></h3><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>八：告警其他方式扩展</strong></h3><p>&nbsp;支持 告警 类型丰富</p><p><img src="//:0" height="477" width="468"></p><h4><strong>8.1邮件： 已经配置实现</strong></h4><p>&nbsp;<img src="//:0" height="262" width="468"></p><p>&nbsp;</p><p><br></p><h4><strong>8.2短信：</strong></h4><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h4><strong>8.3微信：</strong></h4><p>&nbsp;</p><p><br></p><h4><strong>8.4钉钉：已经实现</strong></h4><p>&nbsp;<img src="//:0" height="298" width="468"></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>&nbsp;九：mysqld_exporter&nbsp;B2C监控-开发测试环境数据库监控</strong></h3><p>&nbsp;全面监控 mysql</p><p>&nbsp;<img src="//:0" height="236" width="468"></p><p>&nbsp;</p><p>&nbsp;<a href="http://192.168.9.132:3000/d/MQWgroiiz/b2cjian-kong-kai-fa-ce-shi-huan-jing-shu-ju-ku-jian-kong-mian-ban?refresh=1m&amp;panelId=12&amp;orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/MQWgroiiz/b2cjian-kong-kai-fa-ce-shi-huan-jing-shu-ju-ku-jian-kong-mian-ban?refresh=1m&amp;panelId=12&amp;orgId=1</u></a></p><p><br></p><p><br></p><h3><strong>十：zookeeper_exporter B2C监控-开发测试环境服务注册中心监控</strong></h3><p><br></p><p>&nbsp;<img src="//:0" height="215" width="468"></p><p>&nbsp;<a href="http://192.168.9.132:3000/d/thsec-Nmz/b2cjian-kong-kai-fa-ce-shi-huan-jing-fu-wu-zhu-ce-zhong-xin-jian-kong?orgId=1&amp;var-project=192.168.9.132:9141" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/thsec-Nmz/b2cjian-kong-kai-fa-ce-shi-huan-jing-fu-wu-zhu-ce-zhong-xin-jian-kong?orgId=1&amp;var-project=192.168.9.132:9141</u></a></p><p><br></p><p>&nbsp;</p><p><br></p><h3><strong>十一：redis_exporter B2C监控-开发测试环境服务Redis监控</strong></h3><p><img src="//:0" height="232" width="468"></p><p>&nbsp;</p><p>&nbsp;<a href="http://192.168.9.132:3000/d/Ln69Fc9iz/b2cjian-kong-kai-fa-ce-shi-huan-jing-redisjian-kong?refresh=30s&amp;orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/Ln69Fc9iz/b2cjian-kong-kai-fa-ce-shi-huan-jing-redisjian-kong?refresh=30s&amp;orgId=1</u></a></p><p><br></p><p>&nbsp;</p><p>&nbsp;</p><p><br></p><h3><strong>十二：spring boot B2C监控-节点服务JVM信息监控</strong></h3><p><img src="//:0" height="216" width="468"></p><p><a href="http://192.168.9.132:3000/d/-vu5WBrik/b2cjian-kong-jie-dian-fu-wu-jvmxin-xi-jian-kong?refresh=30s&amp;orgId=1" target="_blank" style="color: rgb(0, 0, 255);"><u>http://192.168.9.132:3000/d/-vu5WBrik/b2cjian-kong-jie-dian-fu-wu-jvmxin-xi-jian-kong?refresh=30s&amp;orgId=1</u></a></p><p>&nbsp;pom.xml&nbsp;无其他侵入</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;io.micrometer&lt;/groupId&gt;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;1.1.3&lt;/version&gt;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</p><p><br></p><p><br></p><p><br></p>